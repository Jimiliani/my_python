{% extends 'base.html' %}
{% block styles %}
    <style>
        #mainContent {
            text-align: center;
        }

        .typeOfUsers {
            display: flex;
            flex-direction: column;
        }

        .typeOfUsers button {
            background: rgba(245, 245, 245, 0.7);
            text-decoration: none;
            color: black;
            padding: 10px 20px;
            border-width: 1px 2px;
            border-style: solid;
            border-top-color: black;
            font-family: 'Pangolin', cursive;
            font-size: 20px;
            cursor: pointer;
            outline: none;
        }

        .typeOfUsers button:first-child {
            border-width: 2px 2px 1px 2px;
            border-radius: 20px 20px 0 0;
        }

        .typeOfUsers button:last-child {
            border-width: 1px 2px 2px 2px;
            border-radius: 0 0 20px 20px;
        }

        .active {
            background: rgba(245, 245, 245, 1.0) !important;
        }

        #users {
            display: flex;
            flex-direction: column;
        }

        .userCard {
            display: flex;
            flex-direction: row;
            background: rgba(245, 245, 245, 0.65);
            margin: 10px 0;
            padding: 10px 0;
            border-width: 1px;
            border-style: solid;
            border-top-color: black;
        }

        .userCardMainContent {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .userCardImage {
            width: 25%;
            margin: 0 10px;
        }

        .userCardImage img {
            width: 100%;
            height: 100%;
        }

        a {
            text-decoration: none;
            color: black;
        }

        .button {
            width: 100%;
            margin: 10px 0;
            padding: 10px 10px 15px 0;
            border-radius: 15px;
            outline: none;
            font-family: 'Pangolin', cursive;
            font-size: 20px;
            cursor: pointer;
        }

        .add-friend {
            background-color: lawngreen;
        }

        .delete-friend {
            background-color: rgb(255, 40, 40);
        }


        .add-friend svg {
            margin: 0 10px -10px 10px;
        }

        .delete-friend svg {
            margin: 0 10px -10px 10px;
        }


    </style>
{% endblock %}
{% block body %}
    <div id="mainContent">
        <div class="typeOfUsers">
            <button class="active" id="myFriends">Мои друзья</button>
            <button id="allUsers">Все пользователи</button>
            <button id="outgoingRequests">Исходящие заявки</button>
            <button id="incomingRequests">Входящие заявки</button>
        </div>
        <div id="users"></div>
    </div>
{% endblock %}
{% block scripts %}
    <script>
        $(window).on('load', function () {
            getAndPrintFriends()
        })

        function openTab() {
            switch (localStorage.getItem('tab')) {
                case 'myFriends':
                    $('#myFriends').click();
                    break
                case 'allUsers':
                    $('#allUsers').click();
                    break
                case 'outgoingRequests':
                    $('#outgoingRequests').click();
                    break
                case 'incomingRequests':
                    $('#incomingRequests').click();
                    break
                default:
                    $('#myFriends').click();
                    break
            }
        }

        function getAndPrintFriends() {
            let id = $('.active').attr('id');
            let friendsProfiles;
            console.log(id);
            $.when(
                $.ajax({
                    url: window.location.href,
                    type: "GET",
                    data: {
                        request_type: id,
                    },
                    dataType: 'json',
                    success: function (friends) {
                        friendsProfiles = JSON.parse(friends)
                    },
                    error: function (data, errors) {
                        console.log(data);
                        console.log(errors);
                    }
                })
            ).then(function () {
                console.log(friendsProfiles);
                printFriends(friendsProfiles);
                openTab();
            })
        }

        function printFriends(profiles) {
            let usersContent = $('#users');
            let content = "";
            console.log(profiles);
            for (let profile of profiles) {
                content += "" +
                    "<div class='userCard'>" +
                    "   <div class='userCardImage'>" +
                    "       <img src='" + profile['profile_picture'] + "'>   " +
                    "   </div>" +
                    "   <div class='userCardMainContent'>" +
                    "       <a href=\"../user/" + profile['id'] + "\">" +
                    profile['full_name'] +
                    "       </a>" +
                    "       <div class='addOrDeleteFriendButton' id=\"" + profile['id'] + "\">\n"
                if (!profile['in_friends']) {
                    content += "" +
                        "                <button class=\"button add-friend\" onclick=\"addFriend(this)\">\n" +
                        "                    <svg width=\"32px\" height=\"32px\" viewBox=\"0 0 16 16\" class=\"bi bi-plus-circle\"\n" +
                        "                         fill=\"currentColor\"\n" +
                        "                         xmlns=\"http://www.w3.org/2000/svg\">\n" +
                        "                        <path fill-rule=\"evenodd\"\n" +
                        "                              d=\"M8 3.5a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5H4a.5.5 0 0 1 0-1h3.5V4a.5.5 0 0 1 .5-.5z\"></path>\n" +
                        "                        <path fill-rule=\"evenodd\"\n" +
                        "                              d=\"M7.5 8a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 0 1H8.5V12a.5.5 0 0 1-1 0V8z\"></path>\n" +
                        "                        <path fill-rule=\"evenodd\"\n" +
                        "                              d=\"M8 15A7 7 0 1 0 8 1a7 7 0 0 0 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z\"></path>\n" +
                        "                    </svg>\n" +
                        "                    Добавить в друзья\n" +
                        "                </button>\n"
                } else {
                    content += "" +
                        "                <button class=\"button delete-friend\" onclick=\"deleteFriend(this)\">\n" +
                        "                    <svg width=\"32px\" height=\"32px\" viewBox=\"0 0 16 16\" class=\"bi bi-dash-circle\"\n" +
                        "                         fill=\"currentColor\" xmlns=\"http://www.w3.org/2000/svg\">\n" +
                        "                        <path fill-rule=\"evenodd\"\n" +
                        "                              d=\"M8 15A7 7 0 1 0 8 1a7 7 0 0 0 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z\"></path>\n" +
                        "                        <path fill-rule=\"evenodd\"\n" +
                        "                              d=\"M3.5 8a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 0 1H4a.5.5 0 0 1-.5-.5z\"></path>\n" +
                        "                    </svg>\n" +
                        "                    Удалить из друзей\n" +
                        "                </button>\n"
                }
                content += "" +
                    "            </div>" +
                    "   </div>" +
                    "</div>"
            }
            usersContent.html(content)
        }
    </script>
    <script>
        $('.typeOfUsers button').on('mouseenter', function () {
            $(this).css('background', 'rgba(245, 245, 245, 1.0)')
        });

        $('.typeOfUsers button').on('mouseleave', function () {
            $(this).css('background', 'rgba(245, 245, 245, 0.7)')
        })

        $('.typeOfUsers button').on('click', function () {
            if ($('.active').attr('id') !== $(this).attr('id')) {
                $('.active').toggleClass('active');
                $(this).toggleClass('active');
                localStorage.setItem('tab', $(this).attr('id'));
                getAndPrintFriends();
            }
        })
    </script>
    <script>
        function addFriend(elem) {
            let friend_id = $(elem).parent().attr('id');
            let button = "" +
                "                <button class=\"button delete-friend\" onclick=\"deleteFriend(this)\">\n" +
                "                    <svg width=\"32px\" height=\"32px\" viewBox=\"0 0 16 16\" class=\"bi bi-dash-circle\"\n" +
                "                         fill=\"currentColor\" xmlns=\"http://www.w3.org/2000/svg\">\n" +
                "                        <path fill-rule=\"evenodd\"\n" +
                "                              d=\"M8 15A7 7 0 1 0 8 1a7 7 0 0 0 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z\"></path>\n" +
                "                        <path fill-rule=\"evenodd\"\n" +
                "                              d=\"M3.5 8a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 0 1H4a.5.5 0 0 1-.5-.5z\"></path>\n" +
                "                    </svg>\n" +
                "                    Удалить из друзей\n" +
                "                </button>";
            console.log(friend_id);
            $.when($.ajax({
                type: "POST",
                url: window.location.href,
                data: {
                    friend_id: $(elem).parent().attr('id'),
                },
                beforeSend: function (xhr, settings) {
                    xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
                },
                success: function (data) {
                    console.log('friend added');
                    $(elem).parent().html(button);
                },
                error: function (data, errors) {
                    console.log(data);
                    console.log(errors);
                }
            })).then(function () {
                getAndPrintFriends()
            })
        }

        function deleteFriend(elem) {
            let friend_id = $(elem).parent().attr('id');
            let button = "" +
                "                <button class=\"button add-friend\" onclick=\"addFriend(this)\">\n" +
                "                    <svg width=\"32px\" height=\"32px\" viewBox=\"0 0 16 16\" class=\"bi bi-plus-circle\"\n" +
                "                         fill=\"currentColor\"\n" +
                "                         xmlns=\"http://www.w3.org/2000/svg\">\n" +
                "                        <path fill-rule=\"evenodd\"\n" +
                "                              d=\"M8 3.5a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5H4a.5.5 0 0 1 0-1h3.5V4a.5.5 0 0 1 .5-.5z\"></path>\n" +
                "                        <path fill-rule=\"evenodd\"\n" +
                "                              d=\"M7.5 8a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 0 1H8.5V12a.5.5 0 0 1-1 0V8z\"></path>\n" +
                "                        <path fill-rule=\"evenodd\"\n" +
                "                              d=\"M8 15A7 7 0 1 0 8 1a7 7 0 0 0 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z\"></path>\n" +
                "                    </svg>\n" +
                "                    Добавить в друзья\n" +
                "                </button>";
            console.log(friend_id);
            $.when($.ajax({
                type: "DELETE",
                url: window.location.href,
                data: {
                    friend_id: $(elem).parent().attr('id'),
                },
                beforeSend: function (xhr, settings) {
                    xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
                },
                success: function (data) {
                    console.log('friend deleted');
                    $(elem).parent().html(button);
                },
                error: function (data, errors) {
                    console.log(data);
                    console.log(errors);
                }
            })).then(function () {
                getAndPrintFriends()
            })
        }
    </script>
{% endblock %}

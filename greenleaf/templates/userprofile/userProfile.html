{% extends 'base.html' %}
{% block styles %}
    <style>

        #profileImage {
            border: 2px solid black;
            width: 50%;
            float: left;
            margin: 0 10px 10px 0;
        }

        #fullName {
            margin: 10px 0;
        }

        #profileInfoContent {
            border-width: 0 0 2px 0;
            border-style: solid;
            border-top-color: black;
        }

        .button {
            width: 100%;
            margin: 10px 0;
            padding: 10px 0 15px 0;
            border-radius: 15px;
            outline: none;
            font-family: 'Pangolin', cursive;
            font-size: 20px;
            cursor: pointer;
        }

        .new-post {
            cursor: pointer;
            background-color: cornflowerblue;
        }

        .new-post svg {
            margin: 0 10px -10px 10px;
        }


        .add-friend {
            background-color: lawngreen;
            display: none;
        }

        .delete-friend {
            background-color: rgb(255, 40, 40);
            display: none;
        }


        .add-friend svg {
            margin: 0 10px -10px 10px;
        }

        .delete-friend svg {
            margin: 0 10px -10px 10px;
        }

        #buttonChanger {
            border-width: 0 0 2px 0;
            border-style: solid;
            border-top-color: black;
            margin-bottom: 10px;
        }

        .post-buttons {
            display: flex;
            flex-direction: row;
            width: 100%;
        }

        .like {
            background: rgb(40, 217, 27);
        }

        .comments {
            background: rgb(19, 55, 255);
            border-radius: 0 0 25px 0;
        }

        .cancel-post-creation {
            background: rgb(255, 40, 40);
            border-radius: 0 0 0 25px;
        }

        .add-new-post {
            background: rgb(40, 217, 27);
            border-radius: 0 0 25px 0;
        }

        .post-content-button {
            width: 100%;
            font-family: 'Pangolin', cursive;
            font-size: 20px;
            outline: none;
            cursor: pointer;
        }

        .post-content-button svg {
            margin: 0 5px -5px 5px;
        }

        .add-post-form {
            margin: 10px 0;
            padding-bottom: 10px;
            border-width: 0 0 2px 0;
            border-style: solid;
            border-top-color: black;
        }

        .post-content-text {
            padding: 10px 20px 0 20px;
            margin-bottom: -10px;
            width: 100%;
            box-sizing: border-box;
            border-radius: 25px 25px 0 0;
            border: 2px solid black;
            outline: none;
            min-height: 50px;
            overflow: hidden;
            font-family: 'Pangolin', cursive;
            font-size: 20px;
        }

        .post {
            margin-bottom: 10px;
        }

        .liked {
            fill: red;
        }

    </style>
{% endblock %}
{% block body %}
    <div id="mainContent">
        <div id="profileInfoContent">
            <img id="profileImage" src="{{ userProfile.profile_picture.url }}" alt="Фото профиля">
            <h3 id="fullName">{{ greenLeafUser.last_name }} {{ greenLeafUser.first_name }}</h3>
            {% if userProfile.city %}<strong>Город: </strong> {{ userProfile.city }}<br>{% endif %}
            {% if userProfile.phone %}<strong>Телефон: </strong> {{ userProfile.phone }}<br>{% endif %}
        </div>
        {% if user.id != greenLeafUser.id %}
            <div id="buttonChanger">
                <button class="button add-friend">
                    <svg width="32px" height="32px" viewBox="0 0 16 16" class="bi bi-plus-circle"
                         fill="currentColor"
                         xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd"
                              d="M8 3.5a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5H4a.5.5 0 0 1 0-1h3.5V4a.5.5 0 0 1 .5-.5z"></path>
                        <path fill-rule="evenodd"
                              d="M7.5 8a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 0 1H8.5V12a.5.5 0 0 1-1 0V8z"></path>
                        <path fill-rule="evenodd"
                              d="M8 15A7 7 0 1 0 8 1a7 7 0 0 0 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"></path>
                    </svg>
                    Добавить в друзья
                </button>

                <button class="button delete-friend">
                    <svg width="32px" height="32px" viewBox="0 0 16 16" class="bi bi-dash-circle"
                         fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd"
                              d="M8 15A7 7 0 1 0 8 1a7 7 0 0 0 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"></path>
                        <path fill-rule="evenodd"
                              d="M3.5 8a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 0 1H4a.5.5 0 0 1-.5-.5z"></path>
                    </svg>
                    Удалить из друзей
                </button>
            </div>
        {% else %}
            <div class="add-post-form">
                <textarea id="newPostText" userId="{{ userProfile.id }}" class="post-content-text"
                          placeholder="Текст поста"></textarea>
                <div class="post-buttons">
                    <button class="post-content-button cancel-post-creation">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                            <path d="M9.036 7.976a.75.75 0 00-1.06 1.06L10.939 12l-2.963 2.963a.75.75 0 101.06 1.06L12 13.06l2.963 2.964a.75.75 0 001.061-1.06L13.061 12l2.963-2.964a.75.75 0 10-1.06-1.06L12 10.939 9.036 7.976z"></path>
                            <path fill-rule="evenodd"
                                  d="M12 1C5.925 1 1 5.925 1 12s4.925 11 11 11 11-4.925 11-11S18.075 1 12 1zM2.5 12a9.5 9.5 0 1119 0 9.5 9.5 0 01-19 0z"></path>
                        </svg>
                        Отмена
                    </button>
                    <button class="post-content-button add-new-post">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                            <path d="M17.28 9.28a.75.75 0 00-1.06-1.06l-5.97 5.97-2.47-2.47a.75.75 0 00-1.06 1.06l3 3a.75.75 0 001.06 0l6.5-6.5z"></path>
                            <path fill-rule="evenodd"
                                  d="M12 1C5.925 1 1 5.925 1 12s4.925 11 11 11 11-4.925 11-11S18.075 1 12 1zM2.5 12a9.5 9.5 0 1119 0 9.5 9.5 0 01-19 0z"></path>
                        </svg>
                        Отправить
                    </button>
                </div>
            </div>
        {% endif %}
        <div class="posts">
            {% for post in posts %}
                <div class="post">
                <textarea class="post-content-text" readonly>
                    {{ post.post_text }}
                    {{ post.publication_date }}
                </textarea>
                    <div class="post-buttons">
                        <button class="post-content-button like">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                                <path fill-rule="evenodd"
                                      d="M6.736 4C4.657 4 2.5 5.88 2.5 8.514c0 3.107 2.324 5.96 4.861 8.12a29.66 29.66 0 004.566 3.175l.073.041.073-.04c.271-.153.661-.38 1.13-.674.94-.588 2.19-1.441 3.436-2.502 2.537-2.16 4.861-5.013 4.861-8.12C21.5 5.88 19.343 4 17.264 4c-2.106 0-3.801 1.389-4.553 3.643a.75.75 0 01-1.422 0C10.537 5.389 8.841 4 6.736 4zM12 20.703l.343.667a.75.75 0 01-.686 0l.343-.667zM1 8.513C1 5.053 3.829 2.5 6.736 2.5 9.03 2.5 10.881 3.726 12 5.605 13.12 3.726 14.97 2.5 17.264 2.5 20.17 2.5 23 5.052 23 8.514c0 3.818-2.801 7.06-5.389 9.262a31.146 31.146 0 01-5.233 3.576l-.025.013-.007.003-.002.001-.344-.666-.343.667-.003-.002-.007-.003-.025-.013A29.308 29.308 0 0110 20.408a31.147 31.147 0 01-3.611-2.632C3.8 15.573 1 12.332 1 8.514z"></path>
                            </svg>
                            Понравилось
                        </button>
                        <button class="post-content-button comments">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                                <path fill-rule="evenodd"
                                      d="M3.25 4a.25.25 0 00-.25.25v12.5c0 .138.112.25.25.25h2.5a.75.75 0 01.75.75v3.19l3.72-3.72a.75.75 0 01.53-.22h10a.25.25 0 00.25-.25V4.25a.25.25 0 00-.25-.25H3.25zm-1.75.25c0-.966.784-1.75 1.75-1.75h17.5c.966 0 1.75.784 1.75 1.75v12.5a1.75 1.75 0 01-1.75 1.75h-9.69l-3.573 3.573A1.457 1.457 0 015 21.043V18.5H3.25a1.75 1.75 0 01-1.75-1.75V4.25z"></path>
                            </svg>
                            Комментарии
                        </button>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>

{% endblock %}
{% block scripts %}
    <script>
        $(window).on('load', function () {
            makeCorrectProfileImageSize();
        });

        $(window).on('resize', function () {
            makeCorrectProfileImageSize();
            makeCorrectTextareaSize();
        });

        function makeCorrectProfileImageSize() {
            let width = $(window).width();
            if (width >= 850) {
                $('#profileImage').css('width', '50%');
                $('#profileInfoContent').css('flex-direction', 'row');
            } else if (width >= 560) {
                $('#profileImage').css('width', '100%');
                $('#profileInfoContent').css('flex-direction', 'column');
            } else {
                $('#profileImage').css('width', '100%');
                $('#profileInfoContent').css('flex-direction', 'column');
            }
        }
    </script>
    <script>
        function toggleLiked(element) {
            let id = $(element).attr('id')
            let svg = $(element).children('svg');
            $.ajax({
                type: svg.hasClass('liked') ? "DELETE" : "POST",
                url: "../api/like-list/" + id + "/",
                dataType: "json",
                data: {
                    post_id: id
                },
                beforeSend: function (xhr, settings) {
                    xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
                },
                success: function (data) {
                    svg.toggleClass('liked');
                    if (svg.hasClass('liked')) {
                        $(element).get(0).lastChild.nodeValue = (parseInt($(element).get(0).lastChild.nodeValue) + 1).toString() + ' ' + $(element).get(0).lastChild.nodeValue.replace(/[0-9]/g, '');
                    } else {
                        $(element).get(0).lastChild.nodeValue = (parseInt($(element).get(0).lastChild.nodeValue) - 1).toString() + ' ' + $(element).get(0).lastChild.nodeValue.replace(/[0-9]/g, '');
                    }
                },
                error: function (data, errors) {
                    console.log(data);
                    console.log(errors);
                }
            })
        }

        function putLikes() {
            $('.like').each(function () {
                let id = $(this).attr('id');
                let elem = $(this);
                console.log($(this));
                $.ajax({
                    type: "GET",
                    url: "../api/like-list/" + id + "/",
                    dataType: "json",
                    success: function (data) {
                        data = data.map((value) => (value.owner))
                        if (data.includes(parseInt({{ user.id }}))) {
                            elem.children('svg').addClass('liked');
                        }
                        elem.get(0).lastChild.nodeValue = (data.length).toString() + ' Понравилось'
                    },
                    error: function (data, errors) {
                        console.log(data);
                        console.log(errors);
                    }
                })
            })
        }
    </script>
    <script>
        $(document).on('load', chooseButton())

        function chooseButton() {
            $.ajax({
                type: "GET",
                url: "../api/friendship-list/" + {{ greenLeafUser.id }} +"/",
                dataType: "json",
                success: function (data) {
                    console.log(data)
                    if (data) {
                        $('.add-friend').css('display', 'none');
                        $('.delete-friend').css('display', 'block');
                    } else {
                        $('.add-friend').css('display', 'block');
                        $('.delete-friend').css('display', 'none');
                    }
                },
                error: function (data, errors) {
                    console.log(data);
                    console.log(errors);
                }
            })
        }

        $('.add-friend').on('click', function () {
            $.ajax({
                type: "POST",
                url: "../api/friendship-list/" + {{ greenLeafUser.id }} +"/",
                dataType: "json",
                data: {
                    user1: parseInt({{ user.id }}),
                    user2: parseInt({{ greenLeafUser.id }}),
                },
                beforeSend: function (xhr, settings) {
                    xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
                },
                success: function (data) {
                    chooseButton()
                },
                error: function (data, errors) {
                    console.log(data);
                    console.log(errors);
                }
            })
        })
        $('.delete-friend').on('click', function () {
            $.ajax({
                type: "DELETE",
                url: "../api/friendship-list/" + {{ greenLeafUser.id }} +"/",
                dataType: "json",
                data: {
                    owner_id: {{ user.id }},
                    friend_id: {{ greenLeafUser.id }}
                },
                beforeSend: function (xhr, settings) {
                    xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
                },
                success: function (data) {
                    chooseButton()
                },
                error: function (data, errors) {
                    console.log(data);
                    console.log(errors);
                }
            })
        })
    </script>
    <script>

        $('textarea').on('input', function () {
            makeCorrectTextareaSize()
        });

        function makeCorrectTextareaSize() {
            $('textarea').each(function () {
                $(this).css('height', '0' + 'px');
                $(this).css('height', $(this).prop('scrollHeight') + 'px');
            })
        }
    </script>
    <script>
        $('.add-new-post').on('click', function () {
            let postTextarea = $('#newPostText');
            if (postTextarea.val() !== '') {
                $.ajax({
                    type: "POST",
                    url: "../api/post-list/",
                    data: {
                        author: {{ greenLeafUser.id }},
                        post_text: postTextarea.val(),
                        id: postTextarea.attr('userId'),
                    },
                    dataType: "json",
                    beforeSend: function (xhr, settings) {
                        xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
                    },
                    success: function (data) {
                        postTextarea.val('');
                        showPosts();
                    },
                    error: function (data, errors) {
                        console.log(data);
                        console.log(errors);
                    }
                });
            }
        })
        $('.cancel-post-creation').on('click', function () {
            let postTextarea = $('#newPostText');
            postTextarea.val('');
        })
    </script>
    <script>
        function showPosts() {
            let content = ""
            $.ajax({
                type: "GET",
                url: "../api/post-list/",
                dataType: "json",
                success: function (posts) {
                    posts = posts.filter((post) => (post['author'] === {{ greenLeafUser.id }}))
                    for (let post of posts.reverse()) {
                        content += "<div class=\"post\">\n" +
                            "                <textarea class=\"post-content-text\" readonly>\n" +
                            "                    " + post['post_text'] + " \n" +
                            "                    " + post['publication_date'] + "\n" +
                            "                </textarea>\n" +
                            "                <div class=\"post-buttons\">\n" +
                            "                    <button class=\"post-content-button like\" id=\"" + post['id'] + "\" onclick='toggleLiked(this)'>\n" +
                            "                        <svg class=\"bi bi-heart-fill\" fill=\" rgb(40, 217, 27) \" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 16 16\" width=\"22\" height=\"22\">\n" +
                            "                            <path fill-rule=\"evenodd\"\n" +
                            "                                  d=\"M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314z\"></path>\n" +
                            "                        </svg>\n" +
                            "                        0 Понравилось\n" +
                            "                    </button>\n" + /*
                            "                    <button class=\"post-content-button comments\">\n" +
                            "                        <svg viewBox=\"0 0 16 16\" class=\"bi bi-chat-left-fill\" fill=\"currentColor\" xmlns=\"http://www.w3.org/2000/svg\" width=\"22\" height=\"22\">\n" +
                            "                            <path fill-rule=\"evenodd\"\n" +
                            "                                  d=\"M2 0a2 2 0 0 0-2 2v12.793a.5.5 0 0 0 .854.353l2.853-2.853A1 1 0 0 1 4.414 12H14a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z\"></path>\n" +
                            "                        </svg>\n" +
                            "                        Комментарии\n" +
                            "                    </button>\n" + */
                            "                </div>\n" +
                            "            </div>"
                    }
                    $('.posts').html(content)
                },
                error: function (data, errors) {
                    console.log(data);
                    console.log(errors);
                },
                complete: function () {
                    makeCorrectTextareaSize()
                    putLikes()
                }
            })
        }

        $(document).on('load', showPosts())
    </script>
{% endblock %}
{% extends 'base.html' %}
{% block styles %}
    <style>

        #profileImage {
            border: 2px solid black;
            width: 50%;
            float: left;
            margin: 0 10px 10px 0;
        }

        #fullName {
            margin: 10px 0;
        }

        #profileInfoContent {
            border-width: 0 0 2px 0;
            border-style: solid;
            border-top-color: black;
        }

        .button {
            width: 100%;
            margin: 10px 0;
            padding: 10px 0 15px 0;
            border-radius: 15px;
            outline: none;
            font-family: 'Pangolin', cursive;
            font-size: 20px;
            cursor: pointer;
        }

        .new-post {
            cursor: pointer;
            background-color: cornflowerblue;
        }

        .new-post svg {
            margin: 0 10px -10px 10px;
        }


        .add-friend {
            background-color: lawngreen;
            display: none;
        }

        .delete-friend {
            background-color: rgb(255, 40, 40);
            display: none;
        }


        .add-friend svg {
            margin: 0 10px -10px 10px;
        }

        .delete-friend svg {
            margin: 0 10px -10px 10px;
        }

        #buttonChanger {
            border-width: 0 0 2px 0;
            border-style: solid;
            border-top-color: black;
            margin-bottom: 10px;
        }

        .post-buttons {
            display: flex;
            flex-direction: row;
            width: 100%;
        }

        .like {
            background: rgb(40, 217, 27);
            border-radius: 0 0 0 25px;
        }

        .comments {
            background: rgb(19, 55, 255);
            border-radius: 0 0 25px 0;
        }

        .cancel-post-creation {
            background: rgb(255, 40, 40);
            border-radius: 0 0 0 25px;
        }

        .add-new-post {
            background: rgb(40, 217, 27);
            border-radius: 0 0 25px 0;
        }

        .post-content-button {
            width: 100%;
            font-family: 'Pangolin', cursive;
            font-size: 20px;
            outline: none;
            cursor: pointer;
        }

        .post-content-button svg {
            margin: 0 5px -5px 5px;
        }

        .add-post-form {
            margin: 10px 0;
            padding-bottom: 10px;
            border-width: 0 0 2px 0;
            border-style: solid;
            border-top-color: black;
        }

        .post-content-text {
            padding: 10px 20px 0 20px;
            margin-bottom: -10px;
            width: 100%;
            box-sizing: border-box;
            border-radius: 25px 25px 0 0;
            border: 2px solid black;
            outline: none;
            min-height: 50px;
            overflow: hidden;
            font-family: 'Pangolin', cursive;
            font-size: 20px;
        }

        .post {
            margin-bottom: 15px;
        }

        .liked {
            fill: red;
        }

        .center {
            margin-right: auto;
            margin-left: auto;
        }
    </style>
{% endblock %}
{% block body %}
    <div id="mainContent">
        <div id="profileInfoContent">
            <img id="profileImage" src="{{ userProfile.profile_picture.url }}" alt="Фото профиля">
            <h3 id="fullName">{{ greenLeafUser.last_name }} {{ greenLeafUser.first_name }}</h3>
            {% if userProfile.city %}<strong>Город: </strong> {{ userProfile.city }}<br>{% endif %}
            {% if userProfile.phone %}<strong>Телефон: </strong> {{ userProfile.phone }}<br>{% endif %}
        </div>
        {% if user.id != greenLeafUser.id %}
            <div id="buttonChanger">
                <button class="button add-friend">
                    <svg width="32px" height="32px" viewBox="0 0 16 16" class="bi bi-plus-circle"
                         fill="currentColor"
                         xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd"
                              d="M8 3.5a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5H4a.5.5 0 0 1 0-1h3.5V4a.5.5 0 0 1 .5-.5z"></path>
                        <path fill-rule="evenodd"
                              d="M7.5 8a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 0 1H8.5V12a.5.5 0 0 1-1 0V8z"></path>
                        <path fill-rule="evenodd"
                              d="M8 15A7 7 0 1 0 8 1a7 7 0 0 0 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"></path>
                    </svg>
                    Добавить в друзья
                </button>
                <button class="button delete-friend">
                    <svg width="32px" height="32px" viewBox="0 0 16 16" class="bi bi-dash-circle"
                         fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd"
                              d="M8 15A7 7 0 1 0 8 1a7 7 0 0 0 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"></path>
                        <path fill-rule="evenodd"
                              d="M3.5 8a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 0 1H4a.5.5 0 0 1-.5-.5z"></path>
                    </svg>
                    Удалить из друзей
                </button>
            </div>
        {% else %}
            <div class="add-post-form">
                <textarea id="newPostText" userId="{{ userProfile.id }}" class="post-content-text"
                          placeholder="Текст поста"></textarea>
                <div class="post-buttons">
                    <button class="post-content-button cancel-post-creation">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                            <path d="M9.036 7.976a.75.75 0 00-1.06 1.06L10.939 12l-2.963 2.963a.75.75 0 101.06 1.06L12 13.06l2.963 2.964a.75.75 0 001.061-1.06L13.061 12l2.963-2.964a.75.75 0 10-1.06-1.06L12 10.939 9.036 7.976z"></path>
                            <path fill-rule="evenodd"
                                  d="M12 1C5.925 1 1 5.925 1 12s4.925 11 11 11 11-4.925 11-11S18.075 1 12 1zM2.5 12a9.5 9.5 0 1119 0 9.5 9.5 0 01-19 0z"></path>
                        </svg>
                        Отмена
                    </button>
                    <button class="post-content-button add-new-post">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                            <path d="M17.28 9.28a.75.75 0 00-1.06-1.06l-5.97 5.97-2.47-2.47a.75.75 0 00-1.06 1.06l3 3a.75.75 0 001.06 0l6.5-6.5z"></path>
                            <path fill-rule="evenodd"
                                  d="M12 1C5.925 1 1 5.925 1 12s4.925 11 11 11 11-4.925 11-11S18.075 1 12 1zM2.5 12a9.5 9.5 0 1119 0 9.5 9.5 0 01-19 0z"></path>
                        </svg>
                        Отправить
                    </button>
                </div>
            </div>
        {% endif %}
        <div class="posts">
            {% for post in posts %}
                <div class="post">
                <textarea class="post-content-text" readonly>
                    {{ post.post_text }}
                    {{ post.publication_date }}
                </textarea>
                    <div class="post-buttons">
                        <button class="post-content-button like" value="{{ post.id }}" onclick="toggleLiked(this)">
                            <svg width="1em" height="1em" viewBox="0 0 16 16"
                                 class="{% if user.profile in post.like.all %} liked {% endif %}"
                                 fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd"
                                      d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314z"></path>
                            </svg>
                            {{ post.like.count }} Понравилось
                        </button>
                        <button class="post-content-button comments">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                                <path fill-rule="evenodd"
                                      d="M3.25 4a.25.25 0 00-.25.25v12.5c0 .138.112.25.25.25h2.5a.75.75 0 01.75.75v3.19l3.72-3.72a.75.75 0 01.53-.22h10a.25.25 0 00.25-.25V4.25a.25.25 0 00-.25-.25H3.25zm-1.75.25c0-.966.784-1.75 1.75-1.75h17.5c.966 0 1.75.784 1.75 1.75v12.5a1.75 1.75 0 01-1.75 1.75h-9.69l-3.573 3.573A1.457 1.457 0 015 21.043V18.5H3.25a1.75 1.75 0 01-1.75-1.75V4.25z"></path>
                            </svg>
                            Комментарии
                        </button>
                    </div>
                </div>
            {% endfor %}
        </div>
        {% if too_many_posts %}
            <button class="more-posts button" value="1" onclick="getExtraPosts($(this))">Больше постов</button>
        {% endif %}
    </div>

{% endblock %}
{% block scripts %}
    <script>
        function getExtraPosts(button) {
            $.ajax({
                type: "GET",
                url: window.location.href,
                data: {
                    request_type: 'get_extra_posts',
                    posts_from: button.val() + '0',
                    posts_to: (parseInt(button.val()) + 1).toString() + '0',
                },
                dataType: "json",
                success: function (data) {
                    button.val(parseInt(button.val()) + 1);
                    let content = ""
                    for (let post of data.posts) {
                        content += "" +
                            "<div class=\"post\">\n" +
                            "                <textarea class=\"post-content-text\" readonly>\n" +
                            "                    " + post.post_text + "\n" +
                            "                    " + post.publication_date + "\n" +
                            "                </textarea>\n" +
                            "                    <div class=\"post-buttons\">\n" +
                            "                        <button class=\"post-content-button like\" value=\"" + post.id + "\" onclick=\"toggleLiked(this)\">\n" +
                            "                            <svg width=\"1em\" height=\"1em\" viewBox=\"0 0 16 16\"\n" +
                            "                                 class=\"" + (post.is_liked_by_user ? "liked" : "") + " \"\n" +
                            "                                 fill=\"currentColor\" xmlns=\"http://www.w3.org/2000/svg\">\n" +
                            "                                <path fill-rule=\"evenodd\"\n" +
                            "                                      d=\"M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314z\"></path>\n" +
                            "                            </svg>\n" +
                            "                            " + post.like_count + " Понравилось\n" +
                            "                        </button>\n" +
                            "                        <button class=\"post-content-button comments\">\n" +
                            "                            <svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\" width=\"24\" height=\"24\">\n" +
                            "                                <path fill-rule=\"evenodd\"\n" +
                            "                                      d=\"M3.25 4a.25.25 0 00-.25.25v12.5c0 .138.112.25.25.25h2.5a.75.75 0 01.75.75v3.19l3.72-3.72a.75.75 0 01.53-.22h10a.25.25 0 00.25-.25V4.25a.25.25 0 00-.25-.25H3.25zm-1.75.25c0-.966.784-1.75 1.75-1.75h17.5c.966 0 1.75.784 1.75 1.75v12.5a1.75 1.75 0 01-1.75 1.75h-9.69l-3.573 3.573A1.457 1.457 0 015 21.043V18.5H3.25a1.75 1.75 0 01-1.75-1.75V4.25z\"></path>\n" +
                            "                            </svg>\n" +
                            "                            Комментарии\n" +
                            "                        </button>\n" +
                            "                    </div>\n" +
                            "                </div>"
                    }
                    $(content).appendTo($('.posts'));
                    if (data.posts.length < 10) {
                        button.css('display', 'none');
                    }
                },
                error: function (data, errors) {
                    console.log(data);
                    console.log(errors);
                }
            })
        }
    </script>
    <script>
        $(window).on('load', function () {
            makeCorrectProfileImageSize();
        });

        $(window).on('resize', function () {
            makeCorrectProfileImageSize();
            makeCorrectTextareaSize();
        });

        function makeCorrectProfileImageSize() {
            let width = $(window).width();
            if (width >= 850) {
                $('#profileImage').css('width', '50%');
                $('#profileInfoContent').css('flex-direction', 'row');
            } else if (width >= 560) {
                $('#profileImage').css('width', '100%');
                $('#profileInfoContent').css('flex-direction', 'column');
            } else {
                $('#profileImage').css('width', '100%');
                $('#profileInfoContent').css('flex-direction', 'column');
            }
        }
    </script>
    <script>
        function toggleLiked(elem) {
            $(elem).unbind('click');
            let svg = $(elem).children('svg');
            console.log(svg.hasClass('liked'));
            $.ajax({
                type: "PATCH",
                url: window.location.href,
                data: JSON.stringify({
                    action_type: (svg.hasClass('liked') ? 'remove' : 'add'),
                    post_id: $(elem).val(),
                }),
                dataType: "json",
                beforeSend: function (xhr, settings) {
                    xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
                },
                success: function (data, textStatus, xhr) {
                    console.log(data.is_liked);
                    console.log(data.count_of_likes);
                    $(elem).replaceWith(
                        "<button class=\"post-content-button like\" value=\"" + $(elem).val() + "\" onclick=\"toggleLiked(this)\">" +
                        "    <svg width=\"1em\" height=\"1em\" viewBox=\"0 0 16 16\" class=\"" + (data.is_liked ? 'liked' : '') + "\" " +
                        "         fill=\"currentColor\" xmlns=\"http://www.w3.org/2000/svg\">\n" +
                        "             <path fill-rule=\"evenodd\"\n" +
                        "                 d=\"M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314z\"></path>\n" +
                        "    </svg>\n" + data.count_of_likes + " Понравилось\n" +
                        "</button>"
                    );
                },
                error: function (data, errors) {
                    console.log(data);
                    console.log(errors);
                }
            });
        }
    </script>
    <script>
        $('.add-friend').on('click', function () {
            $.ajax({
                type: "POST",
                url: window.location.href,
                dataType: "text",
                data: {
                    request_type: 'add_friend',
                    user: {{ greenLeafUser.id }},
                },
                beforeSend: function (xhr, settings) {
                    xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
                },
                success: function (data) {
                    chooseButton()
                },
                error: function (data, errors) {
                    console.log(data);
                    console.log(errors);
                }
            })
        })
        $('.delete-friend').on('click', function () {
            $.ajax({
                type: "POST",
                url: window.location.href,
                dataType: "text",
                data: {
                    request_type: 'delete_friend',
                    user: {{ greenLeafUser.id }},
                },
                beforeSend: function (xhr, settings) {
                    xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
                },
                success: function (data) {
                    chooseButton()
                },
                error: function (data, errors) {
                    console.log(data);
                    console.log(errors);
                }
            })
        })
    </script>
    <script>

        $('textarea').on('input', function () {
            makeCorrectTextareaSize()
        });
        $(window).on('load', function () {
            makeCorrectTextareaSize()
        });

        function makeCorrectTextareaSize() {
            $('textarea').each(function () {
                $(this).css('height', '0' + 'px');
                $(this).css('height', $(this).prop('scrollHeight') + 'px');
            })
        }
    </script>
    <script>
        $('.add-new-post').on('click', function () {
            let $postTextarea = $('#newPostText');
            if ($postTextarea.val() !== '') {
                $.ajax({
                    type: "POST",
                    url: window.location.href,
                    data: {
                        request_type: 'add_post',
                        post_text: $postTextarea.val(),
                    },
                    dataType: "json",
                    beforeSend: function (xhr, settings) {
                        xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
                    },
                    success: function (data, textStatus, xhr) {
                        if (xhr.status === 201) {
                            $postTextarea.val('');
                            $('.posts').prepend("<div class=\"post\">\n" +
                                "                <textarea class=\"post-content-text\" readonly>\n" +
                                "                    " + data.text + "\n" +
                                "                    " + "{% now 'N d, Y, P' %}" + "\n" +
                                "                </textarea>\n" +
                                "                    <div class=\"post-buttons\">\n" +
                                "<button class=\"post-content-button like\" value=\"" + data.id + "\" onclick=\"toggleLiked(this)\">" +
                                "    <svg width=\"1em\" height=\"1em\" viewBox=\"0 0 16 16\" class=\"\" " +
                                "         fill=\"currentColor\" xmlns=\"http://www.w3.org/2000/svg\">\n" +
                                "             <path fill-rule=\"evenodd\"\n" +
                                "                 d=\"M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314z\"></path>\n" +
                                "    </svg>\n" + 0 + " Понравилось\n" +
                                "</button>" +
                                "                        <button class=\"post-content-button comments\">\n" +
                                "                            <svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\" width=\"24\" height=\"24\">\n" +
                                "                                <path fill-rule=\"evenodd\"\n" +
                                "                                      d=\"M3.25 4a.25.25 0 00-.25.25v12.5c0 .138.112.25.25.25h2.5a.75.75 0 01.75.75v3.19l3.72-3.72a.75.75 0 01.53-.22h10a.25.25 0 00.25-.25V4.25a.25.25 0 00-.25-.25H3.25zm-1.75.25c0-.966.784-1.75 1.75-1.75h17.5c.966 0 1.75.784 1.75 1.75v12.5a1.75 1.75 0 01-1.75 1.75h-9.69l-3.573 3.573A1.457 1.457 0 015 21.043V18.5H3.25a1.75 1.75 0 01-1.75-1.75V4.25z\"></path>\n" +
                                "                            </svg>\n" +
                                "                            Комментарии\n" +
                                "                        </button>\n" +
                                "                    </div>\n" +
                                "                </div>");
                        }
                    },
                    error: function (data, errors) {
                        console.log(data);
                        console.log(errors);
                    }
                });
            }
        })
        $('.cancel-post-creation').on('click', function () {
            let $postTextarea = $('#newPostText');
            $postTextarea.val('');
        })
    </script>
{% endblock %}